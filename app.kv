#:import Factory kivy.factory.Factory
#: import WipeTransition kivy.uix.screenmanager.WipeTransition
#:import Clipboard kivy.core.clipboard.Clipboard
#:import Clock kivy.clock
<MorsifierApp>:
    size: root.size
    pos: root.pos


<MainWidget>
    canvas.before:
        Color:
            rgb: .9, .8, .55, 1
        Rectangle:
            pos: self.pos
            size: self.size

    FloatLayout:
        size: root.size
        pos: root.pos

        Image:
            source: "morsifier.png"
            size_hint: .5, .5
            pos_hint: {"center_x": .475, "center_y": .9}

        TextInput:
            id: string_morsify
            disabled: proceed_button.disabled
            size_hint: .75, .1
            pos_hint: {"center_x": .4, "center_y": .75}
            #color: 0, 0, 0, 1
            background_color: 0, 0, 0, 0
            canvas.after:
                Color:
                    rgba: 1, 1, 1, .5
                RoundedRectangle:
                    size: self.size
                    pos: self.pos
                


        Button:
            id: proceed_button
            text: "Proceed"
            disabled: True if len(morse_label.text) > 0 or loop_toggle.state == "down" else False
            disabled: True if len(morse_label.text) > 0 or loop_toggle.state == "down" else False
            text_size: self.size
            font_size: self.width/4
            halign: "center"
            valign: "middle"
            on_press: app.root.string = string_morsify.text.upper(); app.root.translate_to_morse()
            on_release: app.root.typewriter(); copy_morse.disabled = False
            size_hint: .1, .1
            pos_hint: {"center_x": .83, "center_y": .75}
            background_color: 0, 0, 0, 0
            canvas.before:
                Color:
                    rgba: (.33, .33, .33, 1) if self.state == "normal" else (.22, .22, .22, 1)
                RoundedRectangle:
                    size: self.size
                    pos: self.pos

        Button:
            id: reset_button
            text: "Reset"
            text_size: self.size
            font_size: self.width/4
            halign: "center"
            valign: "middle"
            on_press: app.root.typewriter.cancel(); loop_toggle.state = "normal"; app.root.morse_loop.cancel()
            on_release: string_morsify.text = ""; morse_label.text = ""; loop_label.text = "";  copy_morse.disabled = True; app.root.delete_file()
            size_hint: .1, .1
            pos_hint: {"center_x": .935, "center_y": .75}
            background_color: 0, 0, 0, 0
            canvas.before:
                Color:
                    rgba: (.33, .33, .33, 1) if self.state == "normal" else (.22, .22, .22, 1)
                RoundedRectangle:
                    size: self.size
                    pos: self.pos


        ScrollView:
            do_scroll_x: False
            do_scroll_y: True
            size_hint: .95, .4
            pos_hint: {"center_x": .5, "center_y": .375}
            canvas.before:
                Color:
                    rgba: 1, 1, 1, .5
                RoundedRectangle:
                    size: self.size
                    pos: self.pos

            FloatLayout:
                pos: root.pos
                size: self.size
                size_hint_y: None
                Label:
                    id: morse_label
                    markup: True
                    color: 0, 0, 0, 1
                    font_size: 72
                    text_size: self.width, None
                    bold: True
                    halign: "left"
                    valign: "top"
                    height: self.texture_size[1]
                    
                    
                Label:
                    id: loop_label
                    markup: True
                    color: 0, 0, 0, 1
                    font_size: 72
                    text_size: self.width, None
                    bold: True
                    halign: "left"
                    valign: "top"
                    height: self.texture_size[1]
                
        ToggleButton:
            id: loop_toggle
            text: "Loop"
            disabled: False if morse_label.text != "" or proceed_button.disabled == True else True
            on_press: 
                app.root.string = app.root.clipboard; 
                app.root.loop = True; 
                morse_label.text = app.root.string; 
                loop_label.text = app.root.string; 
                app.root.morse_loop(); 
                app.root.play_sound()
            pos_hint: {"center_x": .0775, "center_y": .625}
            size_hint: .1, .05
            background_color: 0, 0, 0, 0
            canvas.before:
                Color:
                    rgba: (.33, .33, .33, 1) if self.state == "normal" else (.22, .22, .22, 1)
                RoundedRectangle:
                    size: self.size
                    pos: self.pos


        Button:
            id: copy_morse
            text: "Copy"
            text_size: self.size
            font_size: self.width/4
            disabled: True
            halign: "center"
            valign: "middle"
            on_release: Clipboard.copy(app.root.clipboard)
            size_hint: .1, .1
            pos_hint: {"center_x": .925, "center_y": .1}
            background_color: 0, 0, 0, 0
            canvas.before:
                Color:
                    rgba: (.33, .33, .33, 1) if self.state == "normal" else (.22, .22, .22, 1)
                RoundedRectangle:
                    size: self.size
                    pos: self.pos


        ToggleButton:
            id: mute_sound
            text: {'normal': "Mute", 'down': "Unmute"} [self.state]
            text_size: self.size
            font_size: self.width/4
            disabled: False
            halign: "center"
            valign: "middle"
            on_release: app.root.mute_sound(); 
            #background_color: {'normal': (0,1,0,1), 'down': (1,0,0,1)} [self.state]
            size_hint: .1, .1
            pos_hint: {"center_x": .82, "center_y": .1}
            background_color: 0, 0, 0, 0
            canvas.before:
                Color:
                    rgba: (0, .5, 0, 1) if self.state == "normal" else (.5, 0, 0, 1)
                RoundedRectangle:
                    size: self.size
                    pos: self.pos


        Button:
            id: download_morse
            text: "Download"
            text_size: self.size
            font_size: self.width/5
            disabled: False if morse_label.text != "" else True
            halign: "center"
            valign: "middle"
            on_release: app.root.show_save()
            size_hint: .11, .1
            pos_hint: {"center_x": .08, "center_y": .1}
            background_color: 0, 0, 0, 0
            canvas.before:
                Color:
                    rgba: (.33, .33, .33, 1) if self.state == "normal" else (.22, .22, .22, 1)
                RoundedRectangle:
                    size: self.size
                    pos: self.pos


<SaveDialog>:
    text_input: text_input
    BoxLayout:
        size: root.size
        pos: root.pos
        orientation: "vertical"
        FileChooserListView:
            id: filechooser
            on_selection: text_input.text = self.selection and self.selection[0] or ''

        TextInput:
            id: text_input
            size_hint_y: None
            height: 30
            multiline: False

        BoxLayout:
            size_hint_y: None
            height: 30
            Button:
                text: "Cancel"
                on_release: root.cancel()

            Button:
                text: "Save"
                on_release: root.save(filechooser.path, text_input.text)